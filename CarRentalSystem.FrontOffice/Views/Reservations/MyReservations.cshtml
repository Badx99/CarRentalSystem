@using CarRentalSystem.FrontOffice.Models.ViewModels
@model MyReservationsViewModel
@{
    ViewData["Title"] = "My Journey History";
}

<div class="bg-purple text-light py-5 mb-5 shadow-sm">
    <div class="container text-center animate-fade-in">
        <h1 class="display-4 fw-bold mb-3"><i class="fas fa-history me-3 text-white"></i>My Account</h1>
        <p class="lead mb-0">Manage your bookings, view receipts, and upcoming journeys.</p>
    </div>
</div>

<div class="container mb-5">
    <div class="row g-4">
        <!-- Dashboard Sidebar -->
        <div class="col-lg-3">
            <div class="card border-0 shadow-sm rounded-4 text-center p-4 sticky-top" style="top: 100px;">
                <div class="mb-4 d-flex justify-content-center">
                    <div class="rounded-circle bg-purple text-white d-flex align-items-center justify-content-center shadow-lg" style="width: 80px; height: 80px; font-size: 2rem;">
                         <i class="fas fa-user"></i>
                    </div>
                </div>
                <h5 class="fw-bold mb-1">@(Context.Items["CustomerEmail"] ?? "Valued Customer")</h5>
                <p class="text-muted small mb-4">Member Since @DateTime.Now.Year</p>
                <div class="d-grid gap-2">
                    <a asp-controller="Auth" asp-action="Profile" class="btn btn-outline-purple btn-sm rounded-pill"><i class="fas fa-user-edit me-2"></i>Edit Profile</a>
                    <a asp-action="MyReservations" class="btn btn-purple btn-sm rounded-pill active"><i class="fas fa-calendar-check me-2"></i>My Bookings</a>
                </div>
            </div>

            <!-- Filter Card -->
            <div class="card border-0 shadow-sm rounded-4 p-4 mt-4 sticky-top" style="top: 380px;">
                <h6 class="fw-bold mb-3"><i class="fas fa-filter text-purple me-2"></i>Filter History</h6>
                <form method="get" asp-action="MyReservations">
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">Status</label>
                        <select name="status" class="form-select border-0 bg-light" asp-for="StatusFilter">
                            <option value="">All Statuses</option>
                            <option value="Confirmed">Confirmed</option>
                            <option value="Pending">Pending</option>
                            <option value="Completed">Completed</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">Date From</label>
                        <input type="date" name="dateFrom" class="form-control border-0 bg-light" asp-for="DateFrom">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">Date To</label>
                        <input type="date" name="dateTo" class="form-control border-0 bg-light" asp-for="DateTo">
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-purple btn-sm rounded-pill">Apply Filters</button>
                        <a asp-action="MyReservations" class="btn btn-outline-secondary btn-sm rounded-pill">Clear</a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Reservations Content -->
        <div class="col-lg-9">
            <ul class="nav nav-pills mb-4 gap-2" id="reservationTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active rounded-pill px-4 shadow-sm" id="active-tab" data-bs-toggle="tab" data-bs-target="#active_res" type="button" role="tab">Active & Upcoming</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link rounded-pill px-4 shadow-sm" id="past-tab" data-bs-toggle="tab" data-bs-target="#past_res" type="button" role="tab">Past History</button>
                </li>
            </ul>

            <div class="tab-content" id="reservationTabsContent">
                <!-- Active Reservations -->
                <div class="tab-pane fade show active" id="active_res" role="tabpanel">
                    @if (Model.CurrentReservations.Any())
                    {
                        <div class="row g-4">
                            @foreach (var res in Model.CurrentReservations)
                            {
                                <div class="col-md-6 fade-in-on-scroll">
                                    <div class="card h-100 border-0 shadow-sm hover-lift rounded-4 overflow-hidden">
                                        <div class="position-absolute top-0 end-0 m-3 z-index-1">
                                            <span class="badge @(res.Status == "Pending" ? "bg-warning" : res.Status == "Confirmed" ? "bg-success" : "bg-info") shadow-sm px-3 py-2 rounded-pill">@res.Status</span>
                                        </div>
                                        <div class="row g-0 h-100">
                                            <div class="col-4">
                                                <img src="@(string.IsNullOrEmpty(res.VehicleImageUrl) ? "/images/placeholder-car.jpg" : res.VehicleImageUrl)" class="h-100 w-100 object-fit-cover" alt="Car" onerror="this.src='/images/placeholder-car.jpg'">
                                            </div>
                                            <div class="col-8">
                                                <div class="card-body p-4">
                                                    <h6 class="text-purple fw-bold small text-uppercase mb-1">Reservation #@res.Id.ToString().Substring(0, 8).ToUpper()</h6>
                                                    <h5 class="fw-bold mb-3">@res.VehicleBrand @res.VehicleModel</h5>
                                                    
                                                    <div class="d-flex justify-content-between mb-3 bg-light p-2 rounded-3">
                                                        <div class="text-center px-2">
                                                            <small class="text-muted d-block small fw-bold">PICK-UP</small>
                                                            <span class="fw-bold fs-6">@res.StartDate.ToString("MMM dd")</span>
                                                        </div>
                                                        <div class="align-self-center"><i class="fas fa-long-arrow-alt-right text-muted"></i></div>
                                                        <div class="text-center px-2">
                                                            <small class="text-muted d-block small fw-bold">RETURN</small>
                                                            <span class="fw-bold fs-6">@res.EndDate.ToString("MMM dd")</span>
                                                        </div>
                                                    </div>

                                                    <div class="d-flex justify-content-between align-items-center mt-auto">
                                                        <h4 class="fw-bold text-success mb-0">$@res.TotalAmount.ToString("N0")</h4>
                                                        <div class="d-flex gap-2">
                                                            <!-- QR Modal Button -->
                                                            @if (!string.IsNullOrEmpty(res.QRCode))
                                                            {
                                                                <button type="button" class="btn btn-sm btn-light-purple px-3 rounded-pill" data-bs-toggle="modal" data-bs-target="#qrModal-@res.Id" title="Show QR Code">
                                                                    <i class="fas fa-qrcode"></i>
                                                                </button>
                                                                
                                                                <!-- QR Modal -->
                                                                <div class="modal fade" id="qrModal-@res.Id" tabindex="-1" aria-hidden="true">
                                                                    <div class="modal-dialog modal-dialog-centered modal-sm">
                                                                        <div class="modal-content border-0 shadow rounded-4 text-center">
                                                                            <div class="modal-header border-0 pb-0">
                                                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                                            </div>
                                                                            <div class="modal-body p-4">
                                                                                <h5 class="fw-bold mb-3">Check-in QR Code</h5>
                                                                                <img src="data:image/png;base64,@res.QRCode" class="img-fluid rounded mb-3" alt="QR Code" style="width: 200px;">
                                                                                <p class="text-muted small">ID: #@res.Id.ToString().Substring(0, 8).ToUpper()</p>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            }
                                                            
                                                            <a asp-action="Details" asp-route-id="@res.Id" class="btn btn-sm btn-purple px-3 rounded-pill">Manage</a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="card border-0 shadow-sm rounded-4 p-5 text-center">
                            <div class="mb-4"><i class="fas fa-car-side fa-4x text-muted opacity-25"></i></div>
                            <h4 class="fw-bold">No active bookings</h4>
                            <p class="text-muted">You haven't booked any vehicles yet. Ready to start your adventure?</p>
                            <a asp-controller="Vehicles" asp-action="Catalog" class="btn btn-purple mt-3 px-5 rounded-pill shadow-purple">Explore Our Fleet</a>
                        </div>
                    }
                </div>

                <!-- Past History -->
                <div class="tab-pane fade" id="past_res" role="tabpanel">
                    @if (Model.PastReservations.Any())
                    {
                        <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="ps-4 py-3 text-muted small text-uppercase">Vehicle</th>
                                            <th class="py-3 text-muted small text-uppercase">Rental Period</th>
                                            <th class="py-3 text-muted small text-uppercase">Price</th>
                                            <th class="py-3 text-muted small text-uppercase text-center">Status</th>
                                            <th class="pe-4 py-3 text-muted small text-uppercase text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var res in Model.PastReservations)
                                        {
                                            <tr>
                                                <td class="ps-4">
                                                    <div class="d-flex align-items-center">
                                                        <img src="@(string.IsNullOrEmpty(res.VehicleImageUrl) ? "/images/placeholder-car.jpg" : res.VehicleImageUrl)" class="rounded-3 me-3" style="width: 60px; height: 40px; object-fit: cover;" alt="Car" onerror="this.src='/images/placeholder-car.jpg'">
                                                        <div>
                                                            <div class="fw-bold">@res.VehicleBrand @res.VehicleModel</div>
                                                            <small class="text-muted">#@res.Id.ToString().Substring(0, 8).ToUpper()</small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="fw-bold small">@res.StartDate.ToString("MMM dd") - @res.EndDate.ToString("MMM dd, yyyy")</div>
                                                    <small class="text-muted">Rental duration: @res.StartDate.ToString("MMM dd") to @res.EndDate.ToString("MMM dd")</small>
                                                </td>
                                                <td><span class="badge bg-light text-success fs-6">$@res.TotalAmount.ToString("N0")</span></td>
                                                <td class="text-center">
                                                    <span class="badge bg-light @(res.Status == "Completed" ? "text-success" : "text-muted") px-3 rounded-pill">@res.Status</span>
                                                </td>
                                                <td class="pe-4 text-end">
                                                    <div class="d-flex justify-content-end gap-2">
                                                        <button type="button" class="btn btn-sm btn-outline-purple rounded-pill" title="Download PDF" onclick="downloadReceipt('@res.Id')"><i class="fas fa-file-pdf"></i></button>
                                                        <a asp-action="Details" asp-route-id="@res.Id" class="btn btn-sm btn-light-purple rounded-pill" title="View Details"><i class="fas fa-eye"></i></a>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="card border-0 shadow-sm rounded-4 p-5 text-center">
                            <i class="fas fa-history fa-4x text-muted opacity-25 mb-4"></i>
                            <h4 class="fw-bold">No journey history</h4>
                            <p class="text-muted">Your past rental history will appear here once you complete your journeys.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>
